{% import '_includes/forms.twig' as forms %}

{% if not sections|length %}
    <p class="light">No Structure sections found. This plugin only works with Structure sections.</p>
{% else %}
    <p class="light" style="margin-bottom: 24px;">
        Configure parent-child relationships between Entry Types. New entries will automatically nest under the configured parent type.
    </p>

    <div class="pane" style="margin-bottom: 24px; background: #f3f7fc; border: 1px solid #d1e3f6;">
        <p style="margin: 0;"><strong>ðŸ’¡ Multi-level hierarchies:</strong> Chain Entry Types (e.g., Article â†’ Category â†’ Landing) for deeper structures.</p>
    </div>

    {% for section in sections %}
        {% set entryTypes = section.getEntryTypes() %}
        {% set typeHierarchy = (settings.sectionConfig[section.uid] ?? {}).typeHierarchy ?? {} %}

        <div class="field" style="margin-bottom: 32px;">
            <h2>{{ section.name }}</h2>
            <p class="light">{{ entryTypes|length }} entry type(s)</p>

            {% if entryTypes|length < 2 %}
                <p class="light">Needs at least 2 entry types to configure hierarchy.</p>
            {% else %}
                <table class="data fullwidth">
                    <thead>
                        <tr>
                            <th>Entry Type</th>
                            <th>Parent Type</th>
                            <th>Selection Strategy</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for type in entryTypes %}
                            {% set config = typeHierarchy[type.uid] ?? {} %}
                            {% set prefix = "sectionConfig[#{section.uid}][typeHierarchy][#{type.uid}]" %}
                            {% set strategy = config.parentSelectionStrategy ?? 'mostRecent' %}
                            {% set parentUid = config.parentTypeUid ?? '' %}

                            <tr>
                                <td style="width: 25%; vertical-align: top; padding-top: 12px;">
                                    <strong>{{ type.name }}</strong>
                                </td>
                                <td style="width: 30%; vertical-align: top;">
                                    {{ forms.selectField({
                                        name: "#{prefix}[parentTypeUid]",
                                        options: [{label: 'â€” None â€”', value: ''}]|merge(
                                            entryTypes|filter(t => t.uid != type.uid)|map(t => {label: t.name, value: t.uid})
                                        ),
                                        value: parentUid,
                                        small: true,
                                        class: 'parent-select'
                                    }) }}
                                </td>
                                <td style="width: 45%; vertical-align: top;">
                                    <div class="strategy-wrap" {{ not parentUid ? 'hidden' }}>
                                        {{ forms.radioGroupField({
                                            name: "#{prefix}[parentSelectionStrategy]",
                                            options: [
                                                {label: 'Most Recent', value: 'mostRecent'},
                                                {label: 'First Created', value: 'firstCreated'},
                                                {label: 'Specific Entry', value: 'specific'}
                                            ],
                                            value: strategy,
                                            small: true,
                                            class: 'strategy-radio'
                                        }) }}
                                        <div class="specific-wrap" style="margin-top: 8px;" {{ strategy != 'specific' ? 'hidden' }}>
                                            {{ forms.elementSelectField({
                                                name: "#{prefix}[specificParentId]",
                                                elementType: 'craft\\elements\\Entry',
                                                selectionLabel: 'Choose entry',
                                                limit: 1,
                                                criteria: {sectionId: section.id, status: null},
                                                elements: (config.specificParentId ?? null) ? [craft.entries.id(config.specificParentId).status(null).one()]|filter : []
                                            }) }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
        {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
{% endif %}

{% js %}
document.querySelectorAll('.parent-select select').forEach(s => {
    s.onchange = () => s.closest('tr').querySelector('.strategy-wrap').hidden = !s.value;
});
document.querySelectorAll('.strategy-radio input').forEach(r => {
    r.onchange = () => r.closest('tr').querySelector('.specific-wrap').hidden = r.value !== 'specific';
});
{% endjs %}

